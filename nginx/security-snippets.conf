# =============================================================================
# Nginx Security Hardening Snippets
# Include in http {} or server {} blocks as needed.
# See NGINX_SECURITY_HARDENING.md for full instructions.
# =============================================================================

# -----------------------------------------------------------------------------
# 1. Hide Nginx version (Server software disclosure)
# Place in: http {} block in /etc/nginx/nginx.conf
# Why: Prevents attackers from fingerprinting and targeting known CVEs
# -----------------------------------------------------------------------------
server_tokens off;

# -----------------------------------------------------------------------------
# 2. Security headers (include in server {} blocks)
# Why each header:
#   X-Content-Type-Options: Prevents MIME-sniffing; mitigates XSS via content-type confusion
#   Referrer-Policy: Controls referrer info sent to other sites; reduces info leakage
#   Strict-Transport-Security: Enforces HTTPS; prevents downgrade/SSL-strip attacks
#   Content-Security-Policy: Mitigates XSS, clickjacking, data injection
# -----------------------------------------------------------------------------
add_header X-Content-Type-Options "nosniff" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# CSP: Basic safe default. Tune for your app (AdSense, GA, etc. may need allowlists).
# See NGINX_SECURITY_HARDENING.md for CosmoVid-specific CSP.
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://pagead2.googlesyndication.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://www.google-analytics.com https://pagead2.googlesyndication.com; frame-src https://googleads.g.doubleclick.net; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'self'; upgrade-insecure-requests;" always;

# -----------------------------------------------------------------------------
# 3. Restrict HTTP OPTIONS (CORS preflight)
# Place in: server {} or location {} blocks
# Why: OPTIONS can reveal CORS config and increase attack surface; only allow where needed
# If your API is same-origin only, you can use the strict version below.
# -----------------------------------------------------------------------------

# Option A: Allow OPTIONS only on /api (for CORS preflight from other origins)
# Use this if your frontend calls the API from other domains.
# map $request_method $limit_options {
#     default 0;
#     OPTIONS  1;
# }
# Then in location /api { ... if ($limit_options) { return 405; } }  # or allow if needed

# Option B: Block OPTIONS and other unused methods globally
# Use if API is same-origin only (CosmoVid default). Allow OPTIONS on /api if you need CORS.
# Add to server {} block:
limit_except GET HEAD POST PUT DELETE PATCH {
    deny all;
}
